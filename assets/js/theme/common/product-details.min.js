import utils from"@bigcommerce/stencil-utils";import"foundation-sites/js/foundation/foundation";import"foundation-sites/js/foundation/foundation.reveal";import ImageGallery from"../product/image-gallery";import modalFactory,{defaultModal,ModalEvents,showAlertModal}from"../global/modal";import _ from"lodash";import Wishlist from"../wishlist";import AlsoBought from"../../chiara/also-bought";import scrollToElement from"scroll-to-element";import mediaQueryListFactory from"./media-query-list";const mediumMedia=mediaQueryListFactory("medium");function shake($el,settings){void 0===settings&&(settings={}),void 0===settings.interval&&(settings.interval=100),void 0===settings.distance&&(settings.distance=10),void 0===settings.times&&(settings.times=4),void 0===settings.complete&&(settings.complete=function(){}),$el.css("position","relative");for(let iter=0;iter<settings.times+1;iter++)$el.animate({left:iter%2==0?settings.distance:-1*settings.distance},settings.interval);$el.animate({left:0},settings.interval,settings.complete)}export default class ProductDetails{constructor($scopeArg,context,productAttributesData={},loadProductAttributes=!1){const $scope=context.enableAlsoBought?$scopeArg.find("[data-also-bought-parent-scope]"):$scopeArg;if(this.$productViewScope=$scopeArg,this.$overlay=$("[data-cart-item-add] .loadingOverlay"),this.$scope=$scope,this.context=context,this.imageGallery=new ImageGallery($("[data-image-gallery]",this.$scope),context),this.imageGallery.init(),this.listenQuantityChange(),this.initRadioAttributes(),Wishlist.load(this.context),this.getTabRequests(),context.enableAlsoBought)try{this.alsoBought=new AlsoBought(this,this.context.chiaraSettings.alsoBoughtOptions)}catch(err){console.error(err)}const $form=$("form[data-cart-item-add]",$scope),$productOptionsElement=$("[data-product-option-change]",$form),hasOptions=($productOptionsElement.html()||"").trim().length,hasDefaultOptions=$productOptionsElement.find("[data-default]").length;this.price=null,this.productId=$('input[name="product_id"]',this.$scope).val(),this.$form=$form,$productOptionsElement.on("change",event=>{this.productOptionsChanged(event),this.setProductVariant()}),$form.on("submit",event=>{this.addProductToCart(event,$form[0])}),$("#form-action-buyNow",$scope).on("click",()=>{$form.find("input[name=action]").val("buy")}),$("#form-action-addToCart",$scope).on("click",()=>{$form.find("input[name=action]").val("add")});let isShowingInvalid=!1;if($("select[required], input[required], textarea[required]",$form).on("invalid",event=>{if(isShowingInvalid)return;if(mediumMedia&&mediumMedia.matches)return;const form=$form.get(0);form&&form.reportValidity&&(isShowingInvalid=!0,scrollToElement(event.target,{offset:-100,duration:100}),_.delay(()=>form.reportValidity(),200),_.delay(()=>{isShowingInvalid=!1},300))}),(_.isEmpty(productAttributesData)||hasDefaultOptions)&&(hasOptions||loadProductAttributes)){const $productId=$('[name="product_id"]',$form).val();utils.api.productAttributes.optionChange($productId,$form.serialize(),"products/bulk-discount-rates",(err,response)=>{const attributesData=response.data||{},attributesContent=response.content||{};this.updateProductAttributes(attributesData),console.log(response.data),hasDefaultOptions?this.updateView(attributesData,attributesContent):this.updateDefaultAttributesForOOS(attributesData)})}else this.updateProductAttributes(productAttributesData);$productOptionsElement.show(),this.previewModal=modalFactory("#previewModal")[0],this.previewModal&&(this.previewModal.$modal.addClass("preview-modal").addClass(`preview-modal--${context.themeSettings.add_to_cart_popup}`),"mini"===context.themeSettings.add_to_cart_popup&&(this.previewModal.$modal.off(ModalEvents.open,this.previewModal.onModalOpen),this.previewModal.$modal.off(ModalEvents.close,this.previewModal.onModalClose),this.previewModal.onModalOpen=this.onMiniPreviewModalOpen.bind(this.previewModal),this.previewModal.onModalClose=this.onMiniPreviewModalClose.bind(this.previewModal),this.previewModal.$modal.on(ModalEvents.open,this.previewModal.onModalOpen),this.previewModal.$modal.on(ModalEvents.close,this.previewModal.onModalClose))),$("[data-tab]",$scope).each((id,elm)=>{$(elm).children().eq(0).children("a").click()}),this.$scope.data("productDetailsInstance",this),utils.hooks.emit("product-productdetails-init",this),"dropdown"!==this.context.themeSettings.swatch_option_display_type&&"both"!==this.context.themeSettings.swatch_option_display_type||import("../../chiara/dropdown-swatches").then(module=>module.default(this,{hideOriginalSwatches:"dropdown"===this.context.themeSettings.swatch_option_display_type,...this.context.chiaraSettings.dropdownSwatchesOptions||{}}))}filterEmptyFilesFromForm(formData){try{for(const[key,val]of formData)val instanceof File&&!val.name&&!val.size&&formData.delete(key)}catch(e){console.error(e)}return formData}setProductVariant(){try{const unsatisfiedRequiredFields=[],options=[];$.each($("[data-product-attribute]"),(index,value)=>{const optionLabel=value.children[0].innerText,optionTitle=optionLabel.split(":")[0].trim(),required=optionLabel.toLowerCase().includes("required"),type=value.getAttribute("data-product-attribute");if("input-file"!==type&&"input-text"!==type&&"input-number"!==type||""!==value.querySelector("input").value||!required||unsatisfiedRequiredFields.push(value),"textarea"===type&&""===value.querySelector("textarea").value&&required&&unsatisfiedRequiredFields.push(value),"date"===type){const isSatisfied=Array.from(value.querySelectorAll("select")).every(select=>0!==select.selectedIndex);if(isSatisfied){const dateString=Array.from(value.querySelectorAll("select")).map(x=>x.value).join("-");return void options.push(`${optionTitle}:${dateString}`)}required&&unsatisfiedRequiredFields.push(value)}if("set-select"===type){const select=value.querySelector("select"),selectedIndex=select.selectedIndex;if(0!==selectedIndex)return void options.push(`${optionTitle}:${select.options[selectedIndex].innerText}`);required&&unsatisfiedRequiredFields.push(value)}if("set-rectangle"===type||"set-radio"===type||"swatch"===type||"input-checkbox"===type||"product-list"===type){const checked=value.querySelector("input:checked");if(checked){if("set-rectangle"===type||"set-radio"===type||"product-list"===type){const label=checked.labels?checked.labels[0].innerText:value.querySelector(`label[for="${checked.id}"]`).innerText;label&&options.push(`${optionTitle}:${label}`)}if("swatch"===type){const label=checked.labels?checked.labels[0].children[0]:value.querySelector(`label[for="${checked.id}"]`).children[0];label&&options.push(`${optionTitle}:${label.title}`)}return void("input-checkbox"===type&&options.push(`${optionTitle}:Yes`))}"input-checkbox"===type&&options.push(`${optionTitle}:No`),required&&unsatisfiedRequiredFields.push(value)}});let productVariant=0===unsatisfiedRequiredFields.length?options.sort().join(", "):"unsatisfied";const view=$(".productView");if(productVariant)if(productVariant="unsatisfied"===productVariant?"":productVariant,view.attr("data-event-type"))view.attr("data-product-variant",productVariant);else{const el=view.find(".productView-title")[0];if(el){const productName=el.innerText,card=$(`[data-name="${productName.replace(/"/g,'\\"')}"]`);card.attr("data-product-variant",productVariant)}}}catch(e){console.error(e)}}getViewModel($scope){return{$priceWithTax:$("[data-product-price-with-tax]",$scope),$priceWithoutTax:$("[data-product-price-without-tax]",$scope),rrpWithTax:{$div:$(".rrp-price--withTax",$scope),$span:$("[data-product-rrp-with-tax]",$scope)},rrpWithoutTax:{$div:$(".rrp-price--withoutTax",$scope),$span:$("[data-product-rrp-price-without-tax]",$scope)},nonSaleWithTax:{$div:$(".non-sale-price--withTax",$scope),$span:$("[data-product-non-sale-price-with-tax]",$scope)},nonSaleWithoutTax:{$div:$(".non-sale-price--withoutTax",$scope),$span:$("[data-product-non-sale-price-without-tax]",$scope)},priceSaved:{$div:$(".price-section--saving",$scope),$span:$("[data-product-price-saved]",$scope)},priceNowLabel:{$span:$(".price-now-label",$scope)},priceLabel:{$span:$(".price-label",$scope)},$weight:$(".productView-info [data-product-weight]",$scope),$increments:$(".form-field--increments :input",$scope),$addToCart:$("#form-action-addToCart",$scope),$buyNow:$("#form-action-buyNow",$scope),$wishlistVariation:$('[data-wishlist-add] [name="variation_id"]',$scope),stock:{$container:$(".form-field--stock",$scope),$input:$("[data-product-stock]",$scope)},sku:{$label:$("dt.sku-label",$scope),$value:$("[data-product-sku]",$scope)},upc:{$label:$("dt.upc-label",$scope),$value:$("[data-product-upc]",$scope)},mpn:{$label:$("dt.mpn-label",$scope),$value:$("[data-product-mpn]",$scope)},quantity:{$text:$(".incrementTotal",$scope),$input:$("[name=qty\\[\\]]",$scope)},$bulkPricing:$(".productView-info-bulkPricing",$scope)}}isRunningInIframe(){try{return window.self!==window.top}catch(e){return!0}}productOptionsChanged(event){const $changedOption=$(event.target),$form=$changedOption.parents("form"),productId=$('[name="product_id"]',$form).val();"file"!==$changedOption.attr("type")&&void 0!==window.FormData&&utils.api.productAttributes.optionChange(productId,$form.serialize(),"products/bulk-discount-rates",(err,response)=>{const productAttributesData=response.data||{},productAttributesContent=response.content||{};this.updateProductAttributes(productAttributesData),this.updateView(productAttributesData,productAttributesContent)})}showProductImage(image){if(_.isPlainObject(image)){const zoomImageUrl=utils.tools.image.getSrc(image.data,this.context.themeSettings.zoom_size),mainImageUrl=utils.tools.image.getSrc(image.data,this.context.themeSettings.product_size);this.imageGallery.setAlternateImage({mainImageUrl:mainImageUrl,zoomImageUrl:zoomImageUrl})}else this.imageGallery.restoreImage()}listenQuantityChange(){this.$scope.on("click","[data-quantity-change] button",event=>{event.preventDefault();const $target=$(event.currentTarget),viewModel=this.getViewModel(this.$scope),$input=viewModel.quantity.$input,quantityMin=parseInt($input.data("quantityMin"),10),quantityMax=parseInt($input.data("quantityMax"),10);let qty=parseInt($input.val(),10);"inc"===$target.data("action")?quantityMax>0?qty+1<=quantityMax&&qty++:qty++:qty>1&&(quantityMin>0?qty-1>=quantityMin&&qty--:qty--),viewModel.quantity.$input.val(qty),viewModel.quantity.$text.text(qty)}),this.getViewModel(this.$scope).quantity.$input.on("keypress",event=>{13===event.keyCode&&event.preventDefault()}),this.$scope.on("change",this.getViewModel(this.$scope).quantity.$input,()=>{const viewModel=this.getViewModel(this.$scope),$input=viewModel.quantity.$input,qty=viewModel.quantity.$input.val(),quantityMin=parseInt($input.data("quantityMin"),10),quantityMax=parseInt($input.data("quantityMax"),10);quantityMin>0&&qty<quantityMin?($input.val(quantityMin),viewModel.quantity.$text.text(quantityMin)):quantityMax>0&&qty>quantityMax&&($input.val(quantityMax),viewModel.quantity.$text.text(quantityMax))})}addProductToCartAsync(){return new Promise(resolve=>{const $form=$("form[data-cart-item-add]",this.$scope),form=$form.get(0),$addToCartBtn=$("#form-action-addToCart",this.$scope),originalBtnVal=$addToCartBtn.val(),waitMessage=$addToCartBtn.data("waitMessage");void 0!==window.FormData&&($addToCartBtn.val(waitMessage).prop("disabled",!0),this.$overlay.show(),utils.api.cart.itemAdd(this.filterEmptyFilesFromForm(new FormData(form)),async(err,response)=>{$addToCartBtn.val(originalBtnVal).prop("disabled",!1),this.$overlay.hide(),resolve([err,response])}))})}addProductToCart(event,form){const $addToCartBtn=$("#form-action-addToCart",$(event.target)),originalBtnVal=$addToCartBtn.val(),waitMessage=$addToCartBtn.data("waitMessage");void 0!==window.FormData&&(event.preventDefault(),$addToCartBtn.val(waitMessage).prop("disabled",!0),this.$overlay.show(),utils.api.cart.itemAdd(this.filterEmptyFilesFromForm(new FormData(form)),async(err,response)=>{const errorMessage=err||response.data.error;if($addToCartBtn.val(originalBtnVal).prop("disabled",!1),this.$overlay.hide(),errorMessage){const tmp=document.createElement("DIV");return tmp.innerHTML=errorMessage,showAlertModal(tmp.textContent||tmp.innerText)}if(this.context.themeSettings.redirect_cart)return void this.redirectTo(response.data.cart_item.cart_url||this.context.urls.cart);if("buy"===form.action.value)return void this.redirectTo(this.context.urls.checkout.single_address);if(this.previewModal){const modal=defaultModal();modal.close(),"hide"!==this.context.themeSettings.add_to_cart_popup&&this.previewModal.open(),this.updateCartContent(this.previewModal,response.data.cart_item.id)}else this.$overlay.show(),this.redirectTo(response.data.cart_item.cart_url||this.context.urls.cart);const productId=$('[name="product_id"]',form).val();$(`.is-open[data-collapsible=productView-options-${productId}]`).first().trigger("click")}))}getCartContent(cartItemId,onComplete){const options={template:"cart/preview",params:{suggest:cartItemId},config:{cart:{suggestions:{limit:4}}}};utils.api.cart.getContent(options,onComplete)}redirectTo(url){this.isRunningInIframe()&&!window.iframeSdk?window.top.location=url:window.location=url}updateCartContent(modal,cartItemId,onComplete){this.getCartContent(cartItemId,(err,response)=>{if(err)return;modal.updateContent(response),this.applyModalAutoClose(modal);const $body=$("body"),$cartQuantity=$("[data-cart-quantity]",modal.$content),$cartCounter=$(".navUser-action .cart-count"),quantity=$cartQuantity.data("cartQuantity")||0;$cartCounter.addClass("cart-count--positive"),$body.trigger("cart-quantity-update",quantity),onComplete&&onComplete(response),shake($(".navUser-item--cart > .navUser-action"))})}showMessageBox(message){const $messageBox=$(".productAttributes-message",this.$scope);message?($(".alertBox-message",$messageBox).text(message),$messageBox.show()):$messageBox.hide()}clearPricingNotFound(viewModel){viewModel.rrpWithTax.$div.hide(),viewModel.rrpWithoutTax.$div.hide(),viewModel.nonSaleWithTax.$div.hide(),viewModel.nonSaleWithoutTax.$div.hide(),viewModel.priceSaved.$div.hide(),viewModel.priceNowLabel.$span.hide(),viewModel.priceLabel.$span.hide()}updatePriceView(viewModel,price){this.clearPricingNotFound(viewModel),price.with_tax&&(viewModel.priceLabel.$span.show(),viewModel.$priceWithTax.html(price.with_tax.formatted)),price.without_tax&&(viewModel.priceLabel.$span.show(),viewModel.$priceWithoutTax.html(price.without_tax.formatted)),price.rrp_with_tax&&(viewModel.rrpWithTax.$div.show(),viewModel.rrpWithTax.$span.html(price.rrp_with_tax.formatted)),price.rrp_without_tax&&(viewModel.rrpWithoutTax.$div.show(),viewModel.rrpWithoutTax.$span.html(price.rrp_without_tax.formatted)),price.saved&&(viewModel.priceSaved.$div.show(),viewModel.priceSaved.$span.html(price.saved.formatted)),price.non_sale_price_with_tax&&(viewModel.priceLabel.$span.hide(),viewModel.nonSaleWithTax.$div.show(),viewModel.priceNowLabel.$span.show(),viewModel.nonSaleWithTax.$span.html(price.non_sale_price_with_tax.formatted)),price.non_sale_price_without_tax&&(viewModel.priceLabel.$span.hide(),viewModel.nonSaleWithoutTax.$div.show(),viewModel.priceNowLabel.$span.show(),viewModel.nonSaleWithoutTax.$span.html(price.non_sale_price_without_tax.formatted))}updateView(data,content=null){const viewModel=this.getViewModel(this.$scope);this.showMessageBox(data.stock_message||data.purchasing_message),_.isObject(data.price)&&this.updatePriceView(viewModel,data.price),_.isObject(data.weight)&&viewModel.$weight.html(data.weight.formatted),data.variantId&&viewModel.$wishlistVariation.val(data.variantId),data.sku?(viewModel.sku.$value.text(data.sku),viewModel.sku.$label.show()):(viewModel.sku.$label.hide(),viewModel.sku.$value.text("")),data.upc?(viewModel.upc.$value.text(data.upc),viewModel.upc.$label.show()):(viewModel.upc.$label.hide(),viewModel.upc.$value.text("")),data.mpn?(viewModel.mpn.$value.text(data.mpn),viewModel.mpn.$label.show()):viewModel.mpn.$value.data("originalMpn")?(viewModel.mpn.$value.text(viewModel.mpn.$value.data("originalMpn")),viewModel.mpn.$label.show()):(viewModel.mpn.$label.hide(),viewModel.mpn.$value.text("")),viewModel.stock.$container.length&&_.isNumber(data.stock)?(viewModel.stock.$container.removeClass("u-hiddenVisually"),viewModel.stock.$input.text(data.stock)):(viewModel.stock.$container.addClass("u-hiddenVisually"),viewModel.stock.$input.text(data.stock)),this.updateDefaultAttributesForOOS(data),data.bulk_discount_rates&&content?viewModel.$bulkPricing.html(content):void 0!==data.bulk_discount_rates&&viewModel.$bulkPricing.html(""),data.purchasable&&this.$scope.find("._addToCartVisibility").filter(":hidden").show()}updateDefaultAttributesForOOS(data){const viewModel=this.getViewModel(this.$scope);data.purchasable&&data.instock?(viewModel.$addToCart.prop("disabled",!1),viewModel.$buyNow.prop("disabled",!1),viewModel.$increments.prop("disabled",!1)):(viewModel.$addToCart.prop("disabled",!0),viewModel.$buyNow.prop("disabled",!0),viewModel.$increments.prop("disabled",!0))}updateProductAttributes(data){const behavior=data.out_of_stock_behavior,inStockIds=data.in_stock_attributes,outOfStockMessage=` (${data.out_of_stock_message})`;this.price=data.price,this.$scope.trigger("price-change"),this.showProductImage(data.image),"hide_option"!==behavior&&"label_option"!==behavior||($("[data-product-attribute-value]",this.$scope).each((i,attribute)=>{const $attribute=$(attribute),attrId=parseInt($attribute.data("productAttributeValue"),10);-1!==inStockIds.indexOf(attrId)?this.enableAttribute($attribute,behavior,outOfStockMessage):this.disableAttribute($attribute,behavior,outOfStockMessage)}),this.$scope.trigger("updateProductAttributes"))}disableAttribute($attribute,behavior,outOfStockMessage){if("set-select"===this.getAttributeType($attribute))return this.disableSelectOptionAttribute($attribute,behavior,outOfStockMessage);"hide_option"===behavior?$attribute.hide():$attribute.addClass("unavailable")}disableSelectOptionAttribute($attribute,behavior,outOfStockMessage){const $select=$attribute.parent();"hide_option"===behavior?($attribute.toggleOption(!1),$select.val()===$attribute.attr("value")&&($select[0].selectedIndex=0)):($attribute.attr("disabled","disabled"),$attribute.html($attribute.html().replace(outOfStockMessage,"")+outOfStockMessage))}enableAttribute($attribute,behavior,outOfStockMessage){if("set-select"===this.getAttributeType($attribute))return this.enableSelectOptionAttribute($attribute,behavior,outOfStockMessage);"hide_option"===behavior?$attribute.show():$attribute.removeClass("unavailable")}enableSelectOptionAttribute($attribute,behavior,outOfStockMessage){"hide_option"===behavior?$attribute.toggleOption(!0):($attribute.prop("disabled",!1),$attribute.html($attribute.html().replace(outOfStockMessage,"")))}getAttributeType($attribute){const $parent=$attribute.closest("[data-product-attribute]");return $parent?$parent.data("productAttribute"):null}initRadioAttributes(){$('[data-product-attribute] input[type="radio"]',this.$scope).each((i,radio)=>{const $radio=$(radio);void 0!==$radio.attr("data-state")&&$radio.on("click",()=>{!0===$radio.data("state")?($radio.prop("checked",!1),$radio.data("state",!1),$radio.trigger("change")):$radio.data("state",!0),this.initRadioAttributes()}),$radio.attr("data-state",$radio.prop("checked"))})}getTabRequests(){if(window.location.hash&&0===window.location.hash.indexOf("#tab-")){const $activeTab=$(".tabs").has(`[href='${window.location.hash}']`),$tabContent=$(`${window.location.hash}`);$activeTab.length>0&&($activeTab.find(".tab").removeClass("is-active").has(`[href='${window.location.hash}']`).addClass("is-active"),$tabContent.addClass("is-active").siblings().removeClass("is-active"))}}onMiniPreviewModalOpen(){$("body").addClass("has-activeModal--miniPreview")}onMiniPreviewModalClose(){$("body").removeClass("has-activeModal--miniPreview"),void 0!==this.autoCloseTimer&&this.autoCloseTimer&&(window.clearInterval(this.autoCloseTimer),this.autoCloseTimer=null)}applyModalAutoClose(modal){const $autoCloseEl=modal.$modal.find("[data-auto-close]");if($autoCloseEl.length>0){let sec=$autoCloseEl.data("autoClose")||5;const $count=$autoCloseEl.find(".count");$count.html(sec),modal.autoCloseTimer=window.setInterval(()=>{sec>1?(sec--,$count.html(sec)):(window.clearInterval(modal.autoCloseTimer),modal.autoCloseTimer=null,modal.close())},1e3)}}}